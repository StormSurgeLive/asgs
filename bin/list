#!/usr/bin/env bash

if [ -z "$_ASGSH_PID" ]; then
  echo "This script is meant to run inside of the ASGS Shell Environment, asgsh."
  exit 1;
fi

source $SCRIPTDIR/monitoring/logging.sh

# list interface for lists of important things (registered ADCIRC builds, ASGS profiles)
_list() {
  LISTNUM=1
  case "${1}" in
    adcirc|adcircs)
      if [ ! -d "$ADCIRC_META_DIR/" ]; then
        echo "nothing is available to list, run 'build adcirc' to build and register a version of ADCIRC."
      else
        for adcirc in $(ls -1 "$ADCIRC_META_DIR/" | sort); do
          printf "% 2d. %s\n" $LISTNUM $adcirc
          LISTNUM=$(($LISTNUM+1))
        done
        return
      fi
      ;;
    configs)
      read -p "Show configs for what year? " year
      if [ -d $SCRIPTDIR/config/$year ]; then
        ls $SCRIPTDIR/config/$year/* | less
      else
        echo ASGS configs for $year do not exist 
      fi
      ;;
    jobs)
      if [ -d "$RUNDIR" ]; then
        find $RUNDIR -name run.properties | xargs grep -h 'hpc.job.prep15.jobid' | awk '{print $3}' 
      else
        echo "Make sure profile has a valid run directory. To reload profile, type the 'rl' command."
      fi
      ;;
    meshes)
      ERRORS=0
      FORCE=${2}
      for m in $(cat $ASGS_MESH_DEFAULTS | grep '")' | sed 's/[")]//g' | awk '{print $1}'); do
        printf "% 2d. %s\n" $LISTNUM $m
        GRIDNAME=$(echo $m | sed 's/|.*$//')
        source $ASGS_MESH_DEFAULTS
        FILE="${INPUTDIR}/${GRIDFILE}"
        if [ ! -d $INPUTDIR ]; then
          mkdir -p $INPUTDIR
        fi
        if [[ ! -e $FILE || $FORCE ]]; then
          echo "  Downloading ..."
          echo "    $MESHURL/$GRIDFILE.xz"
          echo "    ... -> $FILE"
          pushd $INPUTDIR > /dev/null  2>&1
          curl -s $MESHURL/$GRIDFILE.xz > $GRIDFILE.xz
          unxz -f $GRIDFILE.xz > /dev/null 2>&1
          STATUS=$?
          if [ $STATUS != 0 ]; then
            echo "    (failed !!!) uncompressing $GRIDFILE."
            ERRORS=$(($ERRORS+1))
          fi
          popd > /dev/null 2>&1
        fi
        if [ -e $FILE ]; then
          NE=$(head -n 2 $FILE | tail -n 1 | awk '{print $1}')
          echo "$NE elements [$m]"
        fi
        LISTNUM=$(($LISTNUM+1))
      done
      echo Number of errors getting meshes: $ERRORS
      ;;
    platforms)
      cat $ASGS_PLATFORMS | egrep '^init_' | sed 's/init_//g' | sed 's/()//g' | awk '{print "- " $1}'
      ;;
    profile|profiles)
      if [ ! -d "$ASGS_HOME/.asgs/" ]; then
        echo "nothing is available to list, use the 'save' command to save this profile"
      else
        for profile in $(ls -1 "$ASGS_HOME/.asgs/" | sort); do
          printf "% 2d. %s\n" $LISTNUM $profile
          LISTNUM=$(($LISTNUM+1))
        done
        return
      fi
      ;;
    *)
      echo "Supported items to list: 'adcirc', 'configs', 'meshes', 'platforms', 'profiles'"
      ;;
  esac 
}

_list $@
