#!/usr/bin/env bash

if [ -z "$_ASGS_PID" ]; then
  echo "This script is meant to run inside of the ASGS Shell Environment, asgsh."
  exit 1;
fi

# interactive dialog for choosing an EDITOR if not defined
_editor_check() {
  if [ -z "$EDITOR" ]; then
    __DEFAULT_EDITOR=vim
    echo "\$EDITOR is not defined. Please define it now (selection updates environment):"
    echo
    echo "Editors available via PATH"
    for e in vim nano vi; do
      full=$(which `basename $e`)
      echo "- $e	(full path: $full)"
    done 
    read -p "Choose [vim]: " _DEFAULT_EDITOR
    if [ -z "$_DEFAULT_EDITOR" ]; then
      _DEFAULT_EDITOR=$__DEFAULT_EDITOR
    fi
    define editor "$_DEFAULT_EDITOR"
    save profile
    echo
  fi
}

# opens up $EDITOR to directly edit files defined by the case
# statement herein
_edit() {
  # if it's not defined
  _editor_check

  # dispatch subject of edit command
  case "${1}" in
  adcirc)
    BRANCH=${2}
    if [ ! -e "$ADCIRC_META_DIR/$BRANCH" ]; then
      echo "An ADCIRC environment named '$BRANCH' doesn't exist"
      return
    fi
    $EDITOR "$ADCIRC_META_DIR/$BRANCH"
    ;;
  config)
    if [ -z "$ASGS_CONFIG" ]; then
      echo "\$ASGS_CONFIG is not defined. Use 'define config' to specify an ASGS config file."
      return
    elif [ ! -e "$ASGS_CONFIG" ]; then
      echo "ASGS_CONFIG file, '$ASGS_FILE' doesn't exist"
      return
    fi
    $EDITOR $ASGS_CONFIG
    if [ 0 -eq $? ]; then
      read -p "reload edited profile '$_ASGSH_CURRENT_PROFILE'? [y]" reload
      if [[ -z "$reload" || "$reload" = "y" ]]; then
        rl
      else
        echo "warning - profile '$ASGS_CONFIG' has been edited, but the profile has not been reloaded. To reload, use the 'rl' or 'load profile $_ASGSH_CURRENT_PROFILE' command."
      fi
    fi
    ;;
  meshes)
    $EDITOR $ASGS_MESH_DEFAULTS
    ;;
  platforms)
    $EDITOR $ASGS_PLATFORMS
    ;;
  profile)
    NAME=${2}
    if [[ -z "$NAME" || ! -e "$ASGS_HOME/.asgs/$NAME" ]]; then
      echo "An ASGS profile named '$NAME' doesn't exist"
      return
    fi
    $EDITOR "$ASGS_HOME/.asgs/$NAME"
    if [ 0 -eq $? ]; then
      read -p "reload edited profile '$_ASGSH_CURRENT_PROFILE'? [y]" reload
      if [[ -z "$reload" || "$reload" = "y" ]]; then
        rl
      else
        echo "warning - profile '$_ASGSH_CURRENT_PROFILE' has been edited, but not reloaded. To reload, use the 'rl' or 'load profile $_ASGSH_CURRENT_PROFILE' command."
      fi
    fi
    ;;
  statefile)
    if [ -z "$STATEFILE" ]; then
      echo "STATEFILE is not defined. Perhaps you have not defined a config or loaded a completed profile file yet?"
      return
    elif [ ! -e "$STATEFILE" ]; then
      echo "STATEFILE file, '$STATEFULE' doesn't exist"
      return
    fi
    $EDITOR "$STATEFILE"
    ;;
  syslog)
    if [ -z "$SYSLOG" ]; then
      echo "SYSLOG is not defined. Perhaps you have not defined a config or loaded a completed profile file yet?"
    elif [ ! -e "$SYSLOG" ]; then
      echo "Log file, '$SYSLOG' doesn't exist - did it get moved or deleted?"
      return
    fi
    $EDITOR "$SYSLOG"
    ;;
  *)
    echo "Supported options:"
    echo "adcirc <name>  - directly edit named ADCIRC environment file"
    echo "config         - directly edit ASGS_CONFIG, if defined"
    echo "profile <name> - directly edit named ASGS profile (should be followed up with the 'load profile' command"
    echo "statefile      - open STATEFILE from a run in EDITOR for easier forensics"
    echo "syslog         - open SYSLOG from a run in EDITOR for easier forensics"
    ;;
  esac
}

_edit $@
